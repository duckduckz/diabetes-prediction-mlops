name: Deploy Diabetes App to Kubernetes

on:
  workflow_dispatch:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure kubeconfig path (Windows)
        shell: powershell
        run: |
          $path = "$env:USERPROFILE\.kube\config"
          Add-Content -Path $env:GITHUB_ENV -Value "KUBECONFIG=$path"
          kubectl get nodes

      - name: Build Docker image locally
        shell: powershell
        run: |
          docker build -t diabetes-api:latest .

      - name: Apply manifests
        shell: powershell
        run: |
          kubectl apply -f k8s/namespace.yaml
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/service.yaml
          kubectl -n mlops-diabetes rollout restart deployment/diabetes-app
          kubectl -n mlops-diabetes rollout status deployment/diabetes-app
          kubectl -n mlops-diabetes get svc,pods -o wide
          Write-Host "FastAPI: http://localhost:30080/health"
          Write-Host "UI:     http://localhost:30081"
