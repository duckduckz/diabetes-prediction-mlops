name: MLOps Automation (Train → Download → Deploy)

on:
  workflow_dispatch:
  push:
    branches: ["main"]

jobs:
  azure-pipeline:
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login (AZURE_CREDENTIALS)
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Ensure Azure ML extension installed
        shell: powershell
        run: |
          $ErrorActionPreference = "Continue"
          az extension show -n ml 1>$null 2>$null
          if ($LASTEXITCODE -eq 0) {
            Write-Host "Azure ML extension already installed. Updating..."
            az extension update -n ml | Out-Null
            } else {
            Write-Host "Azure ML extension not installed. Installing..."
            az extension add -n ml --yes | Out-Null
            }
            az extension show -n ml

      - name: Run Azure ML pipeline job (train + register)
        shell: powershell
        run: |
          az ml job create `
            --file diabetes-pipeline.yaml `
            --resource-group "azure-diabetes-rg" `
            --workspace-name "diabetes-ml-ws" `
            --stream

  download:
    runs-on: self-hosted
    needs: azure-pipeline
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login (AZURE_CREDENTIALS)
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Ensure Azure ML extension installed
        shell: powershell
        run: |
          $ErrorActionPreference = "Continue"
          az extension show -n ml 1>$null 2>$null
          if ($LASTEXITCODE -eq 0) {
            Write-Host "Azure ML extension already installed. Updating..."
            az extension update -n ml | Out-Null
            } else {
            Write-Host "Azure ML extension not installed. Installing..."
            az extension add -n ml --yes | Out-Null
            }
            az extension show -n ml

      - name: Download latest registered model into ./model
        shell: powershell
        run: |
          if (Test-Path ".\model") { Remove-Item ".\model" -Recurse -Force }
          New-Item -ItemType Directory -Path ".\model" | Out-Null

          az ml model download `
            --name diabetes-classification-model `
            --version latest `
            --download-path ".\model" `
            --resource-group "azure-diabetes-rg" `
            --workspace-name "diabetes-ml-ws"

          # If training saved to output_folder/model/model.pkl, normalize to ./model/model.pkl
          if (Test-Path ".\model\model\model.pkl") {
            Move-Item ".\model\model\model.pkl" ".\model\model.pkl" -Force
            Remove-Item ".\model\model" -Recurse -Force
          }

          if (!(Test-Path ".\model\model.pkl")) {
            Write-Error "model.pkl not found in ./model after download."
          }

          Get-ChildItem ".\model" -Recurse

      - name: Upload model folder as artifact (for deploy job)
        uses: actions/upload-artifact@v4
        with:
          name: model-folder
          path: model

  deploy:
    runs-on: self-hosted
    needs: download
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download model artifact into ./model
        uses: actions/download-artifact@v4
        with:
          name: model-folder
          path: model

      - name: Verify model is present
        shell: powershell
        run: |
          if (!(Test-Path ".\model\model.pkl")) {
            Write-Error "model.pkl missing in deploy job."
          }
          Get-ChildItem ".\model" -Recurse

      - name: Configure kubeconfig path (Windows)
        shell: powershell
        run: |
          $path = "$env:USERPROFILE\.kube\config"
          Add-Content -Path $env:GITHUB_ENV -Value "KUBECONFIG=$path"
          kubectl get nodes

      - name: Build Docker image locally (includes ./model/model.pkl)
        shell: powershell
        run: |
          docker build -t diabetes-api:latest .

      - name: Apply manifests + rollout
        shell: powershell
        run: |
          kubectl apply -f k8s/namespace.yaml
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/service.yaml
          kubectl -n mlops-diabetes rollout restart deployment/diabetes-app
          kubectl -n mlops-diabetes rollout status deployment/diabetes-app
          kubectl -n mlops-diabetes get svc,pods -o wide
          Write-Host "FastAPI: http://localhost:30080/health"
          Write-Host "UI:     http://localhost:30081"
