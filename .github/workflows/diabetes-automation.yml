name: MLOps Automation (Train → Download → Deploy)

on:
  workflow_dispatch:
  push:
    branches: ["main"]

jobs:
  azure-pipeline:
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login (AZURE_CREDENTIALS)
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Ensure Azure ML extension installed (safe)
        shell: powershell
        run: |
          $ErrorActionPreference = "Continue"
          az extension show -n ml 1>$null 2>$null
          if ($LASTEXITCODE -eq 0) {
            Write-Host "Azure ML extension already installed. Updating..."
            az extension update -n ml | Out-Null
          } else {
            Write-Host "Azure ML extension not installed. Installing..."
            az extension add -n ml --yes | Out-Null
          }
          az extension show -n ml
          az ml -h | Out-Null

      - name: Run Azure ML pipeline job (train + register)
        shell: powershell
        run: |
          az ml job create `
            --file diabetes-pipeline.yaml `
            --resource-group "azure-diabetes-rg" `
            --workspace-name "diabetes-ml-ws" `
            --stream

  download:
    runs-on: self-hosted
    needs: azure-pipeline
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login (AZURE_CREDENTIALS)
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Ensure Azure ML extension installed (safe)
        shell: powershell
        run: |
          $ErrorActionPreference = "Continue"
          az extension show -n ml 1>$null 2>$null
          if ($LASTEXITCODE -eq 0) {
            Write-Host "Azure ML extension already installed. Updating..."
            az extension update -n ml | Out-Null
          } else {
            Write-Host "Azure ML extension not installed. Installing..."
            az extension add -n ml --yes | Out-Null
          }
          az extension show -n ml | Out-Null

      - name: Download newest registered model into ./model
        shell: powershell
        run: |
          if (Test-Path ".\model") { Remove-Item ".\model" -Recurse -Force }
          New-Item -ItemType Directory -Path ".\model" | Out-Null

          # Get the highest numeric model version
          $ver = az ml model list `
            --name diabetes-classification-model `
            --resource-group "azure-diabetes-rg" `
            --workspace-name "diabetes-ml-ws" `
            --query "sort_by([].{v: to_number(version)}, &v)[-1].v" -o tsv

          if ([string]::IsNullOrWhiteSpace($ver)) {
            Write-Error "No registered model found named diabetes-classification-model."
          }

          Write-Host "Downloading diabetes-classification-model version: $ver"

          az ml model download `
            --name diabetes-classification-model `
            --version $ver `
            --download-path ".\model" `
            --resource-group "azure-diabetes-rg" `
            --workspace-name "diabetes-ml-ws"
          
          Write-Host "Downloaded files (raw structure):"
          Get-ChildItem ".\model" -Recurse | Select-Object FullName

          $pkl = Get-ChildItem ".\model" -Recurse -Filter "model.pkl" -File | Select-Object -First 1

          if (-not $pkl) {
            Write-Error "model.pkl not found anywhere under ./model. Check register output packaging."
          }
          Write-Host "Found model.pkl at: $($pkl.FullName)"
          Move-Item $pkl.FullName ".\model\model.pkl" -Force

          Get-ChildItem ".\model" -Force | Where-Object { $_.Name -ne "model.pkl" } | Remove-Item -Recurse -Force

          Write-Host "Final model folder:"
          Get-ChildItem ".\model" -Recurse


          

      - name: Upload model folder as artifact (for deploy job)
        uses: actions/upload-artifact@v4
        with:
          name: model-folder
          path: model

  deploy:
    runs-on: self-hosted
    needs: download
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download model artifact into ./model
        uses: actions/download-artifact@v4
        with:
          name: model-folder
          path: model

      - name: Verify model is present
        shell: powershell
        run: |
          if (!(Test-Path ".\model\model.pkl")) {
            Write-Error "model.pkl missing in deploy job."
          }
          Get-ChildItem ".\model" -Recurse

      - name: Configure kubeconfig path (Windows)
        shell: powershell
        run: |
          $path = "$env:USERPROFILE\.kube\config"
          Add-Content -Path $env:GITHUB_ENV -Value "KUBECONFIG=$path"
          kubectl get nodes

      - name: Build Docker image locally (includes ./model/model.pkl)
        shell: powershell
        run: |
          docker build -t diabetes-api:latest .

      - name: Apply manifests + rollout
        shell: powershell
        run: |
          kubectl apply -f k8s/namespace.yaml
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/service.yaml
          kubectl -n mlops-diabetes rollout restart deployment/diabetes-app
          kubectl -n mlops-diabetes rollout status deployment/diabetes-app
          kubectl -n mlops-diabetes get svc,pods -o wide
          Write-Host "FastAPI: http://localhost:30080/health"
          Write-Host "UI:     http://localhost:30081"
