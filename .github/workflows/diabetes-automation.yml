name: MLOps Automation (Train → Download → Deploy)

on:
  workflow_dispatch:
  push:
    branches: ["main"]

jobs:
  azure-pipeline:
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure login (Service Principal)
        shell: powershell
        run: |
          az login --service-principal `
            -u "${{ secrets.AZURE_CLIENT_ID }}" `
            -p "${{ secrets.AZURE_CLIENT_SECRET }}" `
            --tenant "${{ secrets.AZURE_TENANT_ID }}"
          az account set --subscription "${{ secrets.AZURE_SUBSCRIPTION_ID }}"

      - name: Run Azure ML pipeline job
        shell: powershell
        run: |
          # Submit pipeline (it must include your register step)
          az ml job create `
            --file diabetes-pipeline.yaml `
            --resource-group "${{ secrets.AZURE_RESOURCE_GROUP }}" `
            --workspace-name "${{ secrets.AZUREML_WORKSPACE }}" `
            --stream

  download:
    runs-on: self-hosted
    needs: azure-pipeline
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure login (Service Principal)
        shell: powershell
        run: |
          az login --service-principal `
            -u "${{ secrets.AZURE_CLIENT_ID }}" `
            -p "${{ secrets.AZURE_CLIENT_SECRET }}" `
            --tenant "${{ secrets.AZURE_TENANT_ID }}"
          az account set --subscription "${{ secrets.AZURE_SUBSCRIPTION_ID }}"

      - name: Download latest registered model into repo ./model
        shell: powershell
        run: |
          if (Test-Path ".\model") { Remove-Item ".\model" -Recurse -Force }
          New-Item -ItemType Directory -Path ".\model" | Out-Null

          az ml model download `
            --name diabetes-classification-model `
            --version latest `
            --download-path ".\model" `
            --resource-group "${{ secrets.AZURE_RESOURCE_GROUP }}" `
            --workspace-name "${{ secrets.AZUREML_WORKSPACE }}"

          # normalize if the downloaded structure contains model/model.pkl
          if (Test-Path ".\model\model\model.pkl") {
            Move-Item ".\model\model\model.pkl" ".\model\model.pkl" -Force
            Remove-Item ".\model\model" -Recurse -Force
          }

          if (!(Test-Path ".\model\model.pkl")) {
            Write-Error "model.pkl not found in ./model after download."
          }

          Get-ChildItem ".\model" -Recurse

  deploy:
    runs-on: self-hosted
    needs: download
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure kubeconfig path (Windows)
        shell: powershell
        run: |
          $path = "$env:USERPROFILE\.kube\config"
          Add-Content -Path $env:GITHUB_ENV -Value "KUBECONFIG=$path"
          kubectl get nodes

      - name: Build Docker image locally (includes freshly downloaded ./model/model.pkl)
        shell: powershell
        run: |
          docker build -t diabetes-api:latest .

      - name: Apply manifests
        shell: powershell
        run: |
          kubectl apply -f k8s/namespace.yaml
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/service.yaml
          kubectl -n mlops-diabetes rollout restart deployment/diabetes-app
          kubectl -n mlops-diabetes rollout status deployment/diabetes-app
          kubectl -n mlops-diabetes get svc,pods -o wide
          Write-Host "FastAPI: http://localhost:30080/health"
          Write-Host "UI:     http://localhost:30081"
