name: Azure ML - Run Diabetes Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

  workflow_dispatch:

env:
  AZURE_SUBSCRIPTION_ID: e60461c1-7c93-4631-b162-303a5c9f4ed7
  AZURE_RESOURCE_GROUP: azure-diabetes-rg
  AZURE_WORKSPACE: diabetes-ml-ws
  AZURE_LOCATION: westeurope

jobs:
  run-azureml-pipeline:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Azure login using service principal
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Show Azure account (debug)
        run: az account show

      - name: Install Azure ML CLI extension
        run: |
          az version
          az extension add --name ml -y
          az extension show --name ml

      - name: Configure default group/workspace
        run: |
          az configure --defaults \
            group=$AZURE_RESOURCE_GROUP \
            workspace=$AZURE_WORKSPACE \
            location=$AZURE_LOCATION

      - name: Submit Azure ML pipeline job
        run: |
          echo "Submitting diabetes-pipeline.yaml..."
          az ml job create --file diabetes-pipeline.yaml --stream

      - name: List recent jobs
        run: |
          az ml job list --max-results 5 --query "[].{name:name,status:status}"
