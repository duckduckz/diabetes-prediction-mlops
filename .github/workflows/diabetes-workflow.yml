name: Azure ML - Run Diabetes Pipeline

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  AZURE_SUBSCRIPTION_ID: e60461c1-7c93-4631-b162-303a5c9f4ed7
  AZURE_RESOURCE_GROUP: azure-diabetes-rg
  AZURE_WORKSPACE: diabetes-ml-ws
  AZURE_LOCATION: westeurope

jobs:
  run-azureml-pipeline:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Azure login using service principal
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Show Azure account (debug)
        run: az account show

      - name: Install Azure ML CLI extension
        run: |
          az version
          az extension add --name ml -y
          az extension show --name ml

      - name: Configure default group/workspace
        run: |
          az configure --defaults \
            group=$AZURE_RESOURCE_GROUP \
            workspace=$AZURE_WORKSPACE \
            location=$AZURE_LOCATION

      # âœ… DEBUG: confirm which YAML is being used and whether it contains any "name:"
      - name: Debug: show pipeline yaml content
        run: |
          echo "PWD=$(pwd)"
          echo "Repo root files:"
          ls -la
          echo "---- diabetes-pipeline.yaml (first 120 lines) ----"
          nl -ba diabetes-pipeline.yaml | sed -n '1,120p'
          echo "---- grep for lines that start with 'name:' ----"
          grep -n "^[[:space:]]*name:" diabetes-pipeline.yaml || true
          echo "---- grep for lines that contain 'name:' anywhere ----"
          grep -n "name:" diabetes-pipeline.yaml || true

      - name: Submit Azure ML pipeline job (unique name)
        id: submit
        run: |
          echo "Submitting diabetes-pipeline.yaml..."
          RUN_NAME="diabetes-${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}"
          echo "Run name: $RUN_NAME"

          JOB_NAME=$(az ml job create \
            --file diabetes-pipeline.yaml \
            --set name=$RUN_NAME \
            --subscription $AZURE_SUBSCRIPTION_ID \
            --resource-group $AZURE_RESOURCE_GROUP \
            --workspace-name $AZURE_WORKSPACE \
            --query name -o tsv)

          echo "Job submitted: $JOB_NAME"
          echo "job_name=$JOB_NAME" >> $GITHUB_OUTPUT

      - name: Stream job logs
        run: |
          az ml job stream \
            --name ${{ steps.submit.outputs.job_name }} \
            --subscription $AZURE_SUBSCRIPTION_ID \
            --resource-group $AZURE_RESOURCE_GROUP \
            --workspace-name $AZURE_WORKSPACE

      - name: List recent jobs (explicit)
        if: always()
        run: |
          az ml job list \
            --subscription $AZURE_SUBSCRIPTION_ID \
            --resource-group $AZURE_RESOURCE_GROUP \
            --workspace-name $AZURE_WORKSPACE \
            --max-results 10 \
            --query "[].{name:name, exp:experiment_name, status:status, created:creation_context.created_at}" \
            -o table
